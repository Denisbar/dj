#!/bin/bash
function finish() {
  if [[ -z ${PORT} ]]; then
    PORT=8080
  fi
  echo Killing server, pid = $(lsof -i:${PORT} -t)
  kill $(lsof -i:${PORT} -t)
}

env_settings=--dev
if [[ ${PRODUCTION} = true ]]; then
  env_settings=--prod
fi

export PORT
node --harmony ./node_modules/sails/bin/sails lift ${env_settings} &
server_pid=$!
trap finish EXIT
sleep 30 # allow some time to init the database
npm test
ret_code=$?
exit ${ret_code}
